{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <h1>セキュリティログ</h1>
    <hr>
    <!-- フィルターフォーム -->
    <div class="filter-section">
        <form method="GET" action="{{ url_for('security_logs') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="event_type">イベントタイプ:</label>
                    <select id="event_type" name="event_type">
                        <option value="">すべて</option>
                        {% for event_type in event_types %}
                            <option value="{{ event_type }}" {% if selected_event_type == event_type %}selected{% endif %}>{{ event_type }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="username">ユーザー名:</label>
                    <input type="text" id="username" name="username" value="{{ username }}">
                </div>
                
                <div class="form-group">
                    <label for="start_date">開始日:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
                </div>
                
                <div class="form-group">
                    <label for="end_date">終了日:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">フィルター</button>
                    {% if selected_event_type or username or start_date or end_date %}
                    <button type="button" class="btn btn-info" id="filter-reset">フィルター解除</button>
                    {% endif %}
                </div>
            </div>
        </form>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const resetButton = document.getElementById('filter-reset');
                if (resetButton) {
                    resetButton.addEventListener('click', function() {
                        window.location.href = "{{ url_for('security_logs') }}"; // フィルターをリセットするためにURLを再読み込み
                    });
                }
            });
        </script>
    </div>
    
    <!-- ログテーブル -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>日時</th>
                    <th>ユーザー</th>
                    <th>イベントタイプ</th>
                    <th>説明</th>
                    <th>IPアドレス</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs.items %}
                    <tr>
                        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ log.user.username if log.user else 'システム' }}</td>
                        <td>{{ log.event_type }}</td>
                        <td>{{ log.description }}</td>
                        <td>{{ log.ip_address }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center">ログデータがありません</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- ページネーション -->
    {% if logs.pages > 1 %}
        <nav aria-label="ページネーション">
            <ul class="pagination justify-content-center">
                {% for page_num in logs.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == logs.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('security_logs', page=page_num, event_type=selected_event_type, username=username, start_date=start_date, end_date=end_date) }}">{{ page_num }}</a>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </nav>
    {% endif %}
    
    <div class="info-box mt-4">
        <h5>セッション管理関連のイベントタイプ一覧</h5>
        <ul>
            <li><strong>LOGIN</strong>: ユーザーログイン</li>
            <li><strong>LOGOUT</strong>: ユーザーログアウト</li>
            <li><strong>SESSION_LOCK</strong>: 手動セッションロック</li>
            <li><strong>SESSION_UNLOCK</strong>: セッションロック解除</li>
            <li><strong>SESSION_REPLACED</strong>: 他のブラウザ/デバイスからのログインによる古いセッションの置き換え</li>
        </ul>
    </div>
{% endblock %}
